{% extends "rachais/base.html" %}
{% load l10n %}

{% block content %}
<div class="dashboard-shell">

  <aside class="dashboard-sidebar">
    <div class="sidebar-card">
      <div class="sidebar-title">Seus Grupos</div>
      <a class="sidebar-action" href="{% url 'rachais:create_group' %}">+ Criar Novo Grupo</a>
      <div class="sidebar-groups">
        {% for g in groups %}
          <a class="sidebar-link {% if g.id == group.id %}is-active{% endif %}" href="{% url 'rachais:group_detail' g.id %}">{{ g.name }}</a>
        {% empty %}
          <span class="sidebar-empty">Você ainda não participa de nenhum grupo.</span>
        {% endfor %}
      </div>
    </div>
    <div class="sidebar-card debts-card">
      <div class="sidebar-title">Minhas Dívidas</div>

      <div class="debts-tabs">
        <input type="radio" id="tab-pendentes" name="debts-tab" class="debts-tab-radio" checked>
        <label for="tab-pendentes" class="debts-tab-label">Pendentes</label>

        <input type="radio" id="tab-quitadas" name="debts-tab" class="debts-tab-radio">
        <label for="tab-quitadas" class="debts-tab-label">Quitadas</label>
      </div>

      <div class="debts-panels">
        <div class="debts-panel debts-panel--pending">
          {% if my_debts.pending_to_pay or my_debts.pending_to_receive %}
            {% if my_debts.pending_to_pay %}
              <p class="debts-subtitle">Você deve:</p>
              <ul class="debts-list">
                {% for debt in my_debts.pending_to_pay %}
                  <li class="debts-item">
                    <div>
                      <strong>{{ debt.counterparty.get_full_name|default:debt.counterparty.username }}</strong>
                      <small class="debts-group">{{ debt.group.name }}</small>
                    </div>
                    <div class="debts-actions">
                      <span class="debts-amount">R$ {{ debt.amount|localize }}</span>
                      <form method="post" action="{% url 'rachais:pay_debt' %}" onsubmit="return confirm('Confirmar pagamento de R$ {{ debt.amount|localize }} para {{ debt.counterparty.get_full_name|default:debt.counterparty.username }}?');">
                        {% csrf_token %}
                        <input type="hidden" name="group_id" value="{{ debt.group.id }}">
                        <input type="hidden" name="receiver_id" value="{{ debt.counterparty.id }}">
                        <input type="hidden" name="amount" value="{{ debt.amount|floatformat:2 }}">
                        <button type="submit" class="btn-tertiary">Pagar</button>
                      </form>
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}

            {% if my_debts.pending_to_receive %}
              <p class="debts-subtitle">Devem a você:</p>
              <ul class="debts-list">
                {% for debt in my_debts.pending_to_receive %}
                  <li class="debts-item">
                    <div>
                      <strong>{{ debt.counterparty.get_full_name|default:debt.counterparty.username }}</strong>
                      <small class="debts-group">{{ debt.group.name }}</small>
                    </div>
                    <span class="debts-amount positive">R$ {{ debt.amount|localize }}</span>
                  </li>
                {% endfor %}
              </ul>
            {% endif %}
          {% else %}
            <p class="sidebar-empty">Nenhuma pendência no momento.</p>
          {% endif %}
        </div>

        <div class="debts-panel debts-panel--paid">
          {% if my_debts.paid %}
            <ul class="debts-list">
              {% for payment in my_debts.paid %}
                <li class="debts-item debts-item--paid">
                  <div>
                    {% if payment.payer_id == user.id %}
                      Você pagou <strong>{{ payment.receiver.get_full_name|default:payment.receiver.username }}</strong>
                    {% else %}
                      <strong>{{ payment.payer.get_full_name|default:payment.payer.username }}</strong> pagou você
                    {% endif %}
                    <small class="debts-group">{{ payment.group.name }}</small>
                  </div>
                  <div class="debts-meta">
                    <span class="debts-amount">R$ {{ payment.amount|localize }}</span>
                    <span class="debts-date">{{ payment.created_at|date:"d/m/Y H:i" }}</span>
                  </div>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="sidebar-empty">Nenhum pagamento registrado.</p>
          {% endif %}
        </div>
      </div>
    </div>

  </aside>

  <section class="dashboard-main">
  
    {% if messages %}
      <div class="flash-stack">
        {% for m in messages %}
          <div class="flash flash-{{ m.tags|default:'info' }}">{{ m }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <div class="panel">
      <div class="panel-header panel-header--between">
        <div>
          <h1 class="panel-title">{{ group.name }}</h1>
          <p class="panel-subtitle">Adicione participantes e registre as despesas do grupo.</p>
        </div>
        <a class="btn-primary" href="{% url 'rachais:add_expense' group.id %}">+ Adicionar despesa</a>
      </div>
    </div>

    <div class="panel">
      <div class="panel-header panel-header--between">
        <h2 class="panel-title">Participantes</h2>
        <form class="inline-form" method="post" action="{% url 'rachais:add_participant' group.id %}">
          {% csrf_token %}
          <label class="sr-only" for="identifier">Adicionar participante</label>
          <input class="inline-input" id="identifier" name="identifier" type="text" placeholder="Username ou e-mail" required>
          <button class="btn-secondary" type="submit">+ Convidar</button>
        </form>
      </div>

      {% if participants %}
        <ul class="pill-list">
          {% for p in participants %}
            <li class="pill">{{ p.display_name }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="panel-empty">Nenhum participante ainda.</p>
      {% endif %}
    </div>

    <div class="panel">
      <div class="panel-header">
        <h2 class="panel-title">Resumo Consolidado</h2>
      </div>

      {% if settlements %}
        <div class="summary-info">
          <p><strong>Transferências sugeridas:</strong></p>
          <ul class="settlement-list">
            {% for s in settlements %}
              <li class="settlement-item">
                <span class="settlement-debtor">{{ s.from_name }}</span>
                deve
                <span class="settlement-amount">R$ {{ s.amount|localize }}</span>
                para
                <span class="settlement-creditor">{{ s.to_name }}</span>
              </li>
            {% endfor %}
          </ul>
        </div>

        <div class="balance-summary">
          <p><strong>Saldo individual:</strong></p>
          <ul class="balance-list">
            {% for participant in participants %}
              <li class="balance-item">
                <span class="balance-name">{{ participant.display_name }}:</span>
                {% if participant.balance > 0 %}
                  <span class="balance-positive">R$ {{ participant.balance|localize }}</span> a receber
                {% elif participant.balance < 0 %}
                  <span class="balance-negative">R$ {{ participant.balance_abs|localize }}</span> a pagar
                {% else %}
                  <span class="balance-zero">R$ 0,00</span> quite
                {% endif %}
              </li>
            {% endfor %}
          </ul>
        </div>
      {% else %}
        <p class="panel-empty">Nenhuma dívida no momento. Tudo certo por aqui!</p>
      {% endif %}
    </div>

    <div class="panel">
      <div class="panel-header panel-header--between">
        <h2 class="panel-title">Despesas</h2>
        <a class="btn-secondary" href="{% url 'rachais:add_expense' group.id %}">+ Adicionar</a>
      </div>

      {% if expenses %}
        <ul class="expense-list">
          {% for e in expenses %}
            <li class="expense-item">
              <div class="expense-main">
                <div>
                  <div class="expense-name">{{ e.description }}</div>
                  <div class="expense-meta">Pago por {{ e.paid_by_name }}</div>
                </div>
                <div class="expense-amount">R$ {{ e.amount|localize }}</div>
              </div>
              
              <div class="expense-split">
                {% if e.split_list %}
                  <strong>{{ e.get_split_method_display }}:</strong> 
                  {% for s in e.split_list %}
                    {{ s.name }} deve R$ {{ s.amount|localize }}{% if not forloop.last %}; {% else %}.{% endif %}
                  {% endfor %}
                {% else %}
                  <strong>{{ e.get_split_method_display }}:</strong> ninguém para dividir ainda.
                {% endif %}
              </div>
            </li>
          {% endfor %}
        </ul>
        <div class="expense-total">
          <span>Total do grupo:</span>
          <strong>R$ {{ total|localize }}</strong>
        </div>
      {% else %}
        <p class="panel-empty">Nenhuma despesa adicionada.</p>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}