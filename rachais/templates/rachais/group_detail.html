{% extends "base.html" %}
{% block content %}
<div class="layout">
  <aside class="sidebar">
    <h2>Seus Grupos</h2>
    <a href="{% url 'rachais:create_group' %}" class="btn btn-block">+ Criar Novo Grupo</a>
    <div style="margin-top:12px">
      <a class="group-item" href="#">{{ group.name }}</a>
    </div>
  </aside>

  <section class="content">
    {% if messages %}
      {% for m in messages %}
        <div class="banner {% if m.tags %}banner-{{ m.tags }}{% endif %}">
          {{ m }}
        </div>
      {% endfor %}
    {% endif %}

    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
      <div>
        <h1>{{ group.name }}</h1>
        <p class="subtitle">Adicione participantes e comece a registrar despesas</p>
      </div>
      <a href="{% url 'rachais:add_expense' group.id %}" class="btn">+ Adicionar Despesa</a>
    </div>

    <!-- PARTICIPANTES -->
    <div class="card" style="margin-top:16px">
      <h3>Participantes</h3>

      <form method="post" action="{% url 'rachais:add_participant' group.id %}" style="margin:8px 0 12px">
        {% csrf_token %}
        <label for="identifier">Username ou e-mail</label>
        <input id="identifier" name="identifier" type="text" placeholder="ex.: joao ou joao@email.com" required>
        <div class="form-actions">
          <button class="btn btn-light" type="submit">+ Convidar Participante</button>
        </div>
      </form>

      {% with plist=group.participants.all %}
        {% if plist %}
          <ul style="list-style:none;padding:0;margin:8px 0 0;display:flex;flex-wrap:wrap;gap:8px">
            {% for p in plist %}
              <li class="group-item" style="display:inline-block;margin:0">{{ p.display_name }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="empty">Nenhum participante ainda</p>
        {% endif %}
      {% endwith %}
    </div>

    <!-- DESPESAS -->
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <h3>Despesas</h3>
        <a href="{% url 'rachais:add_expense' group.id %}" class="btn btn-light">+ Adicionar</a>
      </div>

      {% if expenses %}
        <ul style="list-style:none;padding:0;margin:0">
          {% for e in expenses %}
            <li style="padding:12px 0;border-bottom:1px solid #eee">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <div style="font-weight:600">{{ e.description }}</div>
                  <div class="muted">
                    Pago por {{ e.paid_by_name }}
                  </div>
                </div>
                <div style="font-weight:700">R$ {{ e.amount }}</div>
              </div>

              {% if e.split_list %}
                <div class="muted" style="margin-top:6px">
                  <strong>Divisão igual:</strong>
                  {% for s in e.split_list %}
                    {{ s.name }} deve R$ {{ s.amount }}{% if not forloop.last %};{% else %}.{% endif %}
                  {% endfor %}
                </div>
              {% else %}
                <div class="muted" style="margin-top:6px">
                  <strong>Divisão igual:</strong> não há outros participantes para dividir.
                </div>
              {% endif %}
            </li>
          {% endfor %}
        </ul>

        <div style="margin-top:10px;text-align:right">
          <span class="muted" style="margin-right:6px">Total do grupo:</span>
          <span style="font-size:1.125rem;font-weight:800">R$ {{ total }}</span>
        </div>
      {% else %}
        <p class="empty">Nenhuma despesa adicionada</p>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}
